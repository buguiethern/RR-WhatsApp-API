<!-- public/index.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>WhatsApp API</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Emoji Picker -->
  <link href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.19.0/index.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.19.0/index.js"></script>

  <style>
    body { background:#0a0a0a; color:#00ff88; font-family:'Courier New', monospace; }
    .container { margin-top:50px; }
    .card { background:#111; border:1px solid #00ff88; border-radius:0; box-shadow:0 0 20px rgba(0,255,136,.3); }
    .form-control,.form-control:focus { background:#1a1a1a; border:1px solid #00ff88; color:#00ff88; border-radius:0; }
    .form-control:focus { box-shadow:0 0 10px rgba(0,255,136,.5); }
    h1,h2 { color:#00ff88; text-transform:uppercase; letter-spacing:1px; }

    .btn-primary { background:#00ff88; border-color:#00ff88; color:#000; text-transform:uppercase; letter-spacing:1px; border-radius:0; }
    .btn-primary:hover { background:#00cc66; border-color:#00cc66; box-shadow:0 0 15px rgba(0,255,136,.6); }

    .btn-outline-secondary { border-color:#00ff88; color:#00ff88; text-transform:uppercase; letter-spacing:1px; border-radius:0; }
    .btn-outline-secondary:hover { background:#00ff88; color:#000; }

    .btn-danger { background:#ff0040; border-color:#ff0040; color:#fff; text-transform:uppercase; letter-spacing:1px; border-radius:0; }
    .btn-danger:hover { background:#cc0033; border-color:#cc0033; }

    .btn-success { background:#00ff88; border-color:#00ff88; color:#000; text-transform:uppercase; letter-spacing:1px; border-radius:0; }
    .btn-success:hover { background:#00cc66; border-color:#00cc66; box-shadow:0 0 15px rgba(0,255,136,.6); }

    .btn-outline-danger { border-color:#ff0040; color:#ff0040; text-transform:uppercase; letter-spacing:1px; border-radius:0; }
    .btn-outline-danger:hover { background:#ff0040; color:#fff; }

    .muted { color:#666; font-size:.95em; }
    .loading { text-align:center; font-size:1.2em; color:#00ff88; }

    .qr-wrap { display:flex; justify-content:center; align-items:center; }
    #qrCode { max-width:260px; max-height:260px; border:2px solid #00ff88; filter:invert(1); }

    .message-editor {
      background:#1a1a1a;
      border:1px solid #00ff88;
      padding:10px;
      min-height:120px;
      resize:none;
      border-radius:0;
      color:#00ff88;
      white-space:pre-wrap;
      overflow-wrap:anywhere;
    }
    .message-editor:focus { outline:none; box-shadow:0 0 10px rgba(0,255,136,.5); }

    .format-toolbar { background:#111; border:1px solid #00ff88; padding:5px; margin-bottom:5px; position:relative; }
    .format-toolbar button {
      background:none; border:1px solid #00ff88; color:#00ff88;
      padding:5px 10px; margin-right:5px;
      text-transform:uppercase; letter-spacing:1px; border-radius:0;
    }
    .format-toolbar button:hover { background:#00ff88; color:#000; }

    .file-preview { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    .preview-item { position:relative; border:1px solid #00ff88; padding:10px; background:#1a1a1a; }
    .preview-item img,.preview-item video { max-width:100px; max-height:100px; }
    .preview-item .file-info { margin-top:5px; font-size:12px; text-align:center; }
    .preview-item .remove-preview {
      position:absolute; top:5px; right:5px;
      background:#ff0040; color:white; border:none; border-radius:50%;
      width:20px; height:20px; cursor:pointer;
    }

    .api-docs-btn { margin-top:30px; text-align:center; }
    .api-docs-btn button {
      background:#00ff88; border:2px solid #00ff88; color:#000;
      padding:15px 30px; text-transform:uppercase; letter-spacing:2px;
      font-weight:bold; font-size:18px; border-radius:0; cursor:pointer;
      box-shadow:0 0 20px rgba(0,255,136,.5);
    }
    .api-docs-btn button:hover { background:#000; color:#00ff88; transform:scale(1.05); transition:all .3s; }

    .recipients-list { display:flex; flex-wrap:wrap; gap:8px; min-height:60px; align-content:flex-start; }
    .recipient-tag {
      display:inline-flex; align-items:center;
      background:#00ff88; color:#000;
      padding:6px 12px; border-radius:0;
      font-size:14px; font-weight:bold; text-transform:uppercase; letter-spacing:1px;
      border:none;
      gap:8px;
    }
    .recipient-tag .tag-sub { font-weight:normal; font-size:12px; opacity:.85; text-transform:none; letter-spacing:0; }
    .recipient-tag .remove-tag {
      background:none; border:none; color:#000; margin-left:6px;
      cursor:pointer; font-size:16px; font-weight:bold; line-height:1;
    }
    .recipient-tag .remove-tag:hover { color:#660000; }

    .progress-bar-container {
      width:100%; height:30px; background:#1a1a1a; border:1px solid #00ff88;
      border-radius:0; overflow:hidden; margin:10px 0; display:none;
    }
    .progress-bar-fill {
      height:100%; background:linear-gradient(90deg,#00ff88,#00cc66);
      width:0%; transition:width .3s ease; position:relative;
    }
    .progress-bar-text {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      color:#000; font-weight:bold; font-size:14px; text-transform:uppercase; letter-spacing:1px;
      white-space:nowrap;
    }

    .modal-content { background:#111; border:1px solid #00ff88; color:#00ff88; border-radius:0; }
    .modal-header { border-bottom:1px solid #00ff88; }
    .modal-footer { border-top:1px solid #00ff88; }
    .btn-close { filter:invert(1) hue-rotate(75deg); }

    /* ‚úÖ Bot√µes da linha de destinat√°rios (pra garantir clique/visual) */
    .btn-mini {
      border:1px solid #00ff88;
      color:#00ff88;
      background:transparent;
      padding:10px 14px;
      border-radius:0;
      text-transform:uppercase;
      letter-spacing:1px;
      font-weight:bold;
      white-space:nowrap;
    }
    .btn-mini:hover { background:#00ff88; color:#000; }

    .debugbox {
      margin-top:10px;
      border:1px dashed #00ff88;
      padding:10px;
      background:#0f0f0f;
      display:none;
    }
    .debugbox pre {
      margin:0;
      white-space:pre-wrap;
      word-break:break-word;
      color:#00ff88;
      font-size:12px;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card p-4">
        <h1 class="text-center mb-4">> WHATSAPP API <</h1>

        <h2>> ENVIAR MENSAGEM</h2>
        <form id="messageForm" action="/api/send" method="POST" enctype="multipart/form-data" class="mb-4" accept-charset="UTF-8">
          <div class="mb-3">
            <label for="recipientsInput" class="form-label">DESTINAT√ÅRIOS</label>

            <div style="display:flex; gap:10px; margin-bottom:10px;">
              <input type="text" id="recipientsInput" class="form-control"
                     placeholder="Digite telefone ou nome do grupo..." style="flex:1;">
              <button type="button" id="addRecipientBtn" class="btn-mini">+ ADICIONAR</button>
              <button type="button" id="importContactsBtn" class="btn-mini">üìÅ IMPORTAR JSON</button>
            </div>

            <div id="recipientsList" class="recipients-list"
                 style="min-height:50px; border:1px solid #00ff88; padding:10px; border-radius:0; background:#1a1a1a; margin-bottom:10px;">
              <div class="muted" style="color:#666;">Nenhum destinat√°rio adicionado</div>
            </div>

            <!-- ‚úÖ sempre enviar JSON aqui -->
            <input type="hidden" id="recipients" name="recipients" value="[]">

            <div class="muted mt-1">
              DICA: JSON pode ser:
              [{"nome":"JO√ÉO","email":"a@b.com","telefones":["(11)99999-9999"]}]
              <br>
              Vari√°veis: $nome, $email, $telefone, $telefone_formatado, $grupo (se for grupo)
            </div>

            <!-- ‚úÖ debug opcional (ativa no console via window.__DEBUG_RECIPIENTS__=true) -->
            <div class="debugbox" id="debugBox">
              <div class="muted">DEBUG recipients hidden:</div>
              <pre id="debugRecipients"></pre>
            </div>
          </div>

          <div class="mb-3">
            <label for="delayInput" class="form-label">TEMPO ENTRE MENSAGENS (SEGUNDOS)</label>
            <input type="number" id="delayInput" name="delay" class="form-control"
                   value="1.2" min="0" max="60" step="0.1" placeholder="1.2">
            <div class="muted mt-1">TEMPO DE ESPERA ENTRE O ENVIO DE UMA MENSAGEM E OUTRA. PADR√ÉO: 1.2 SEGUNDOS.</div>
          </div>

          <div class="mb-3">
            <label for="countrySelect" class="form-label">PA√çS PARA FORMATA√á√ÉO</label>
            <select id="countrySelect" name="country" class="form-control">
              <option value="BR">üáßüá∑ BRASIL (+55)</option>
              <option value="US">üá∫üá∏ ESTADOS UNIDOS (+1)</option>
              <option value="OTHER">üåç OUTRO (SEM FORMATA√á√ÉO)</option>
            </select>
            <div class="muted mt-1">ESCOLHA O FORMATO QUE SER√Å APLICADO AOS TELEFONES.</div>
          </div>

          <div class="mb-3">
            <label for="message" class="form-label">MENSAGEM</label>
            <div class="format-toolbar">
              <button type="button" id="boldBtn">*</button>
              <button type="button" id="italicBtn">_</button>
              <button type="button" id="emojiBtn">üòÄ</button>
              <span id="emojiPicker" style="display:inline-block;"></span>
            </div>

            <div class="message-editor" id="messageEditor" contenteditable="true"></div>
            <textarea id="message" name="message" class="d-none"></textarea>

            <div class="muted mt-1">ARRASTE E SOLTE IMAGENS, PDFS OU VIDEOS AQUI.</div>
            <div class="file-preview" id="filePreview"></div>
          </div>

          <div class="progress-bar-container" id="progressContainer">
            <div class="progress-bar-fill" id="progressBar">
              <div class="progress-bar-text" id="progressText">AGUARDANDO...</div>
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100" id="btnSend">> ENVIAR MENSAGEM</button>
        </form>

        <hr class="my-4">

        <h2 id="connectionStatus" class="text-center">CARREGANDO STATUS...</h2>
        <div id="connectBtn" class="text-center mt-3"></div>
        <div class="muted text-center mt-3" id="stateHint"></div>

        <div class="api-docs-btn">
          <button type="button" onclick="window.open('doc.html','_blank')">> DOCUMENTA√á√ÉO DA API</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal QR -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="qrModalLabel">CONECTAR AO WHATSAPP</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <h6>ESCANEIE O QR CODE ABAIXO:</h6>

        <div id="qrCodeContainer" class="mt-3">
          <div class="loading" id="loadingMessage">CARREGANDO QR CODE...</div>

          <div class="qr-wrap mt-2">
            <img id="qrCode" src="" alt="QR Code" style="display:none;">
          </div>

          <div class="muted mt-3" id="qrHint" style="display:none;">SE EXPIRAR, CLIQUE EM "ATUALIZAR QR".</div>

          <button class="btn btn-outline-secondary w-100 mt-3" id="btnRefreshQR" type="button">ATUALIZAR QR</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Mensagens -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="messageModalLabel">MENSAGEM</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="messageModalBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">FECHAR</button>
      </div>
    </div>
  </div>
</div>

  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/config.js"></script>

<script>
  let qrModalInstance = null;
  let ws = null;
  let attachedFiles = [];

  // ‚úÖ recipients agora √© array de objetos: { raw, label, vars }
  let recipients = [];

  // ‚úÖ debug opcional
  const DEBUG = !!window.__DEBUG_RECIPIENTS__;

  function showDebug() {
    const box = document.getElementById('debugBox');
    const pre = document.getElementById('debugRecipients');
    if (!DEBUG) { box.style.display = 'none'; return; }
    box.style.display = 'block';
    pre.textContent = document.getElementById('recipients').value || '';
  }

  function showMessageModal(title, message, type) {
    const messageModalLabel = document.getElementById('messageModalLabel');
    const messageModalBody = document.getElementById('messageModalBody');
    messageModalLabel.textContent = title;
    messageModalBody.innerHTML = `<div class="alert alert-${type}" role="alert">${escapeHtml(message)}</div>`;
    const messageModal = new bootstrap.Modal(document.getElementById('messageModal'));
    messageModal.show();
  }

  function escapeHtml(str) {
    return String(str ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  // ===== STATUS / QR =====
  async function loadStatus() {
    try {
      const r = await fetch('/api/status', { cache: 'no-store' });
      const data = await r.json();

      const connectionStatus = document.getElementById('connectionStatus');
      const connectBtn = document.getElementById('connectBtn');
      const stateHint = document.getElementById('stateHint');

      if (data.status === 'connected') {
        connectionStatus.textContent = `CONECTADO AO WHATSAPP: ${data.number || ''}`.trim();
        stateHint.textContent = data.state ? `ESTADO: ${data.state}` : '';
        connectBtn.innerHTML = `
          <div class="btn-row" style="display:flex; gap:10px;">
            <button style="flex:1;" class="btn btn-danger" id="btnDisconnect">DESCONECTAR</button>
            <button style="flex:1;" class="btn btn-outline-danger" id="btnReset">RESETAR SESS√ÉO</button>
          </div>
        `;

        document.getElementById('btnDisconnect').addEventListener('click', disconnect);
        document.getElementById('btnReset').addEventListener('click', resetSession);
      } else {
        connectionStatus.textContent = 'N√ÉO CONECTADO AO WHATSAPP';
        stateHint.textContent = data.state ? `ESTADO: ${data.state}` : '';
        connectBtn.innerHTML = `
          <div class="btn-row" style="display:flex; gap:10px;">
            <button style="flex:1;" class="btn btn-success" id="btnConnect">CONECTAR</button>
            <button style="flex:1;" class="btn btn-outline-danger" id="btnReset">RESETAR SESS√ÉO</button>
          </div>
        `;

        document.getElementById('btnConnect').addEventListener('click', showQrCode);
        document.getElementById('btnReset').addEventListener('click', resetSession);
      }
    } catch (err) {
      console.error('Erro ao verificar status:', err);
      document.getElementById('connectionStatus').textContent = 'ERRO AO CARREGAR O STATUS';
    }
  }

  async function fetchAndShowQr() {
    const loadingMessage = document.getElementById('loadingMessage');
    const qrCode = document.getElementById('qrCode');
    const qrHint = document.getElementById('qrHint');

    loadingMessage.style.display = 'block';
    qrCode.style.display = 'none';
    qrHint.style.display = 'none';

    try {
      const r = await fetch('/api/qr', { cache: 'no-store' });
      const ct = (r.headers.get('content-type') || '').toLowerCase();

      if (ct.includes('application/json')) {
        const data = await r.json();
        if (data.status === 'connected') {
          loadingMessage.style.display = 'none';
          showMessageModal('Info', data.message || 'J√Å CONECTADO.', 'info');
          if (qrModalInstance) qrModalInstance.hide();
          await loadStatus();
          return;
        }
        if (data.status === 'waiting') {
          loadingMessage.textContent = data.message || 'AGUARDANDO GERAR QR...';
          return;
        }
        loadingMessage.textContent = data.message || 'ERRO AO GERAR QR.';
        return;
      }

      const blob = await r.blob();
      const url = URL.createObjectURL(blob);

      qrCode.src = url;
      loadingMessage.style.display = 'none';
      qrCode.style.display = 'block';
      qrHint.style.display = 'block';
    } catch (err) {
      console.error('Erro ao carregar QR:', err);
      loadingMessage.textContent = 'ERRO AO CARREGAR QR CODE.';
    }
  }

  function showQrCode() {
    qrModalInstance = new bootstrap.Modal(document.getElementById('qrModal'));
    qrModalInstance.show();
    fetchAndShowQr();
  }

  async function disconnect() {
    try {
      await fetch('/api/disconnect', { cache: 'no-store' });
      showMessageModal('DESCONECTADO', 'DESCONECTADO E REINICIALIZADO!', 'warning');
      document.getElementById('messageModal').addEventListener('hidden.bs.modal', async () => {
        await loadStatus();
      }, { once: true });
    } catch (err) {
      console.error('Erro ao desconectar:', err);
      showMessageModal('ERRO', 'ERRO AO DESCONECTAR.', 'danger');
    }
  }

  async function resetSession() {
    try {
      const r = await fetch('/api/reset', { cache: 'no-store' });
      const txt = await r.text().catch(() => '');
      showMessageModal('SESS√ÉO', txt || 'SESS√ÉO RESETADA! GERE NOVO QR.', 'warning');
      document.getElementById('messageModal').addEventListener('hidden.bs.modal', async () => {
        await loadStatus();
      }, { once: true });
    } catch (err) {
      console.error('Erro ao resetar sess√£o:', err);
      showMessageModal('ERRO', 'ERRO AO RESETAR SESS√ÉO (TALVEZ /api/reset N√ÉO EXISTA).', 'danger');
    }
  }

  // ===== WS =====
  function connectWebSocket() {
    try {
      const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
      const host = location.hostname;
      const wsPort = window.__WS_PORT__ ? `:${window.__WS_PORT__}` : (location.port ? `:${location.port}` : '');
      const wsUrl = `${protocol}://${host}${wsPort}`;

      ws = new WebSocket(wsUrl);

      ws.onopen = () => console.log('[WS] conectado:', wsUrl);
      ws.onclose = () => {
        console.log('[WS] desconectado, tentando reconectar...');
        setTimeout(connectWebSocket, 1500);
      };
      ws.onerror = (e) => console.log('[WS] erro:', e);

      ws.onmessage = async (event) => {
        let data;
        try { data = JSON.parse(event.data); } catch { return; }

        if (data.type === 'qr') {
          if (!qrModalInstance) qrModalInstance = new bootstrap.Modal(document.getElementById('qrModal'));
          qrModalInstance.show();
          await fetchAndShowQr();
        }

        if (data.type === 'authenticated' || data.type === 'ready') {
          if (qrModalInstance) qrModalInstance.hide();
          await loadStatus();
        }

        if (data.type === 'disconnected') await loadStatus();

        if (data.type === 'change_state' || data.type === 'state') {
          const stateHint = document.getElementById('stateHint');
          if (data.state) stateHint.textContent = `ESTADO: ${data.state}`;
        }

        if (data.type === 'send_progress') {
          if (data.step === 'starting') {
            showProgress();
            updateProgress(0, data.total, 'INICIANDO...');
          } else if (data.step === 'sending') {
            updateProgress(data.current, data.total, `${data.recipient}`);
          } else if (data.step === 'completed') {
            updateProgress(data.total, data.total, `${data.success}/${data.total} - CONCLU√çDO!`);
            setTimeout(() => {
              const submitButton = document.getElementById('btnSend');
              submitButton.disabled = false;
              submitButton.textContent = '> ENVIAR MENSAGEM';
            }, 1000);
          }
        }
      };
    } catch (err) {
      console.error('[WS] erro ao iniciar:', err);
      setTimeout(connectWebSocket, 1500);
    }
  }

  // ===== EDITOR QUEBRAS =====
  function getEditorPlainTextPreserveLines() {
    const editor = document.getElementById('messageEditor');
    let t = editor.innerText || '';
    t = t.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    t = t.replace(/\u2028|\u2029/g, '\n');
    t = t.replace(/\u00A0/g, ' ');
    t = t.replace(/[ \t]+\n/g, '\n');
    return t;
  }

  function updateHiddenTextarea() {
    document.getElementById('message').value = getEditorPlainTextPreserveLines();
  }

  function surroundSelection(prefix) {
    const editor = document.getElementById('messageEditor');
    editor.focus();

    const sel = window.getSelection();
    if (!sel || sel.rangeCount === 0) return;

    const range = sel.getRangeAt(0);
    if (!editor.contains(range.commonAncestorContainer)) return;

    const selected = range.toString();
    const insert = prefix + selected + prefix;

    range.deleteContents();
    range.insertNode(document.createTextNode(insert));
  }

  function insertAtCursor(text) {
    const editor = document.getElementById('messageEditor');
    editor.focus();

    const sel = window.getSelection();
    if (!sel || sel.rangeCount === 0) {
      editor.appendChild(document.createTextNode(text));
      return;
    }
    const range = sel.getRangeAt(0);
    if (!editor.contains(range.commonAncestorContainer)) {
      editor.appendChild(document.createTextNode(text));
      return;
    }
    range.deleteContents();
    range.insertNode(document.createTextNode(text));
    range.collapse(false);
    sel.removeAllRanges();
    sel.addRange(range);
  }

  function initEmojiPicker() {
    const picker = new EmojiPicker();
    const emojiBtn = document.getElementById('emojiBtn');
    const container = document.getElementById('emojiPicker');

    container.appendChild(picker);

    picker.style.display = 'none';
    picker.style.position = 'absolute';
    picker.style.right = '0';
    picker.style.top = '38px';
    picker.style.zIndex = '1000';

    emojiBtn.addEventListener('click', (e) => {
      e.preventDefault();
      picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
    });

    picker.addEventListener('emoji-click', (event) => {
      const emoji = event.detail.emoji.unicode;
      insertAtCursor(emoji);
      picker.style.display = 'none';
    });

    document.addEventListener('click', (e) => {
      if (e.target === emojiBtn) return;
      if (container.contains(e.target)) return;
      picker.style.display = 'none';
    });
  }

  // ===== DRAG/DROP FILES =====
  function initDragDrop() {
    const editor = document.getElementById('messageEditor');
    const previewContainer = document.getElementById('filePreview');

    editor.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
    });

    editor.addEventListener('drop', (e) => {
      e.preventDefault();
      const files = e.dataTransfer.files;
      handleFiles(files);
    });

    function handleFiles(files) {
      for (let file of files) {
        if (attachedFiles.length >= 5) {
          showMessageModal('ERRO', 'M√ÅXIMO DE 5 ARQUIVOS POR MENSAGEM.', 'warning');
          return;
        }
        const allowedTypes = ['image/jpeg','image/png','image/gif','application/pdf','video/mp4','video/webm'];
        if (!allowedTypes.includes(file.type)) {
          showMessageModal('ERRO', 'FORMATO N√ÉO SUPORTADO. APENAS IMAGENS, PDFS E V√çDEOS.', 'danger');
          continue;
        }
        attachedFiles.push(file);
        renderPreview(file, attachedFiles.length - 1);
      }
    }

    function renderPreview(file, index) {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'preview-item';

      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-preview';
      removeBtn.type = 'button';
      removeBtn.textContent = '√ó';
      removeBtn.addEventListener('click', () => {
        attachedFiles.splice(index, 1);
        itemDiv.remove();
        updateFileInputs();
      });
      itemDiv.appendChild(removeBtn);

      if (file.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        itemDiv.appendChild(img);
      } else if (file.type === 'application/pdf') {
        const pdfIcon = document.createElement('div');
        pdfIcon.textContent = 'üìÑ';
        pdfIcon.style.fontSize = '50px';
        itemDiv.appendChild(pdfIcon);
      } else if (file.type.startsWith('video/')) {
        const video = document.createElement('video');
        video.src = URL.createObjectURL(file);
        video.style.maxWidth = '100px';
        video.style.maxHeight = '100px';
        itemDiv.appendChild(video);
      }

      const fileInfo = document.createElement('div');
      fileInfo.className = 'file-info';
      fileInfo.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
      itemDiv.appendChild(fileInfo);

      previewContainer.appendChild(itemDiv);
      updateFileInputs();
    }

    function updateFileInputs() {
      const form = document.getElementById('messageForm');
      const existingInputs = form.querySelectorAll('input[type="file"].__dynfile');
      existingInputs.forEach(input => input.remove());

      if (attachedFiles.length > 0) {
        attachedFiles.forEach((file, idx) => {
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.name = idx === 0 ? 'file' : `file${idx + 1}`;
          fileInput.className = 'd-none __dynfile';
          form.appendChild(fileInput);

          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          fileInput.files = dataTransfer.files;
        });
      }
    }
  }

  // ===== RECIPIENTS =====
  function updateRecipientsHidden() {
    const hiddenInput = document.getElementById('recipients');
    hiddenInput.value = JSON.stringify(recipients);
    showDebug();
  }

  function updateRecipientsList() {
    const list = document.getElementById('recipientsList');

    if (recipients.length === 0) {
      list.innerHTML = '<div class="muted" style="color:#666;">Nenhum destinat√°rio adicionado</div>';
      updateRecipientsHidden();
      return;
    }

    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.flexWrap = 'wrap';
    wrapper.style.gap = '8px';

    for (let i = 0; i < recipients.length; i++) {
      const r = recipients[i];

      const tag = document.createElement('div');
      tag.className = 'recipient-tag';

      const title = document.createElement('span');
      title.textContent = r.label || r.raw;
      tag.appendChild(title);

      const hasSub = r.vars && (r.vars.nome || r.vars.email);
      if (hasSub) {
        const sub = document.createElement('span');
        sub.className = 'tag-sub';
        sub.textContent = `${r.vars.nome || ''}${r.vars.email ? ' ‚Ä¢ ' + r.vars.email : ''}`.trim();
        tag.appendChild(sub);
      }

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'remove-tag';
      btn.textContent = '√ó';
      btn.addEventListener('click', () => removeRecipient(i));
      tag.appendChild(btn);

      wrapper.appendChild(tag);
    }

    list.innerHTML = '';
    list.appendChild(wrapper);

    updateRecipientsHidden();
  }

  function addRecipientFromRaw(raw, vars = {}) {
    const value = String(raw || '').trim();
    if (!value) return false;

    if (recipients.some(r => String(r.raw || '').toLowerCase() === value.toLowerCase())) return false;

    recipients.push({
      raw: value,
      label: value,
      vars: (vars && typeof vars === 'object') ? vars : {}
    });
    return true;
  }

  function addRecipient() {
    console.log('[DEBUG] addRecipient called');
    alert('Adicionar clicado - fun√ß√£o chamada');
    const input = document.getElementById('recipientsInput');
    const value = input.value.trim();
    console.log('[DEBUG] input value:', value);

    if (!value) {
      console.log('[DEBUG] showing empty field modal');
      try {
        showMessageModal('ERRO', 'DIGITE UM TELEFONE OU NOME DE GRUPO.', 'warning');
      } catch (e) {
        console.error('[DEBUG] error showing modal:', e);
      }
      return;
    }

    const ok = addRecipientFromRaw(value, {});
    console.log('[DEBUG] addRecipientFromRaw returned:', ok);
    if (!ok) {
      console.log('[DEBUG] showing duplicate modal');
      try {
        showMessageModal('AVISO', 'DESTINAT√ÅRIO J√Å ADICIONADO OU INV√ÅLIDO.', 'warning');
      } catch (e) {
        console.error('[DEBUG] error showing modal:', e);
      }
      return;
    }

    input.value = '';
    updateRecipientsList();
    input.focus();
  }

  function removeRecipient(index) {
    recipients.splice(index, 1);
    updateRecipientsList();
  }

  function normalizeVars(obj) {
    const out = {};
    if (!obj || typeof obj !== 'object') return out;
    for (const [k, v] of Object.entries(obj)) {
      const key = String(k || '').trim();
      if (!key) continue;
      if (key.toLowerCase() === 'telefones') continue;
      if (v === null || v === undefined) continue;
      out[key] = (typeof v === 'string') ? v : String(v);
    }
    return out;
  }

  function importContacts() {
    console.log('[DEBUG] importContacts called');
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'application/json,.json';
    fileInput.style.display = 'none';
    console.log('[DEBUG] created file input');

    fileInput.addEventListener('change', () => {
      console.log('[DEBUG] file input change event fired');
      const file = fileInput.files && fileInput.files[0];
      console.log('[DEBUG] selected file:', file);
      if (!file) {
        console.log('[DEBUG] no file selected');
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);

          if (!Array.isArray(parsed)) {
            showMessageModal('ERRO', 'O JSON PRECISA SER UMA LISTA (ARRAY).', 'danger');
            return;
          }

          let imported = 0;
          let skipped = 0;

          for (const contact of parsed) {
            if (!contact || typeof contact !== 'object') { skipped++; continue; }

            const vars = normalizeVars(contact);
            const name = (typeof contact.nome === 'string') ? contact.nome.trim() : '';
            const tels = Array.isArray(contact.telefones) ? contact.telefones : [];

            for (const t of tels) {
              const tel = String(t || '').trim();
              if (!tel) { skipped++; continue; }

              if (recipients.some(r => String(r.raw || '').toLowerCase() === tel.toLowerCase())) {
                skipped++;
                continue;
              }

              recipients.push({
                raw: tel,
                label: name ? `${name} - ${tel}` : tel,
                vars: { ...vars, telefone: tel }
              });
              imported++;
            }
          }

          updateRecipientsList();
          showMessageModal('SUCESSO', `IMPORTADO: ${imported} | IGNORADO: ${skipped}`, 'success');

        } catch (e) {
          console.error(e);
          showMessageModal('ERRO', 'FORMATO JSON INV√ÅLIDO. VERIFIQUE O ARQUIVO.', 'danger');
        }
      };

      reader.readAsText(file, 'utf-8');
    });

    document.body.appendChild(fileInput);
    console.log('[DEBUG] appended fileInput to body, clicking...');
    fileInput.click();
    console.log('[DEBUG] fileInput.click() called');
    setTimeout(() => {
      fileInput.remove();
      console.log('[DEBUG] removed fileInput');
    }, 2000);
  }

  // ===== PROGRESS =====
  function showProgress() { document.getElementById('progressContainer').style.display = 'block'; }
  function hideProgress() { document.getElementById('progressContainer').style.display = 'none'; }
  function updateProgress(current, total, text = null) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
    progressBar.style.width = percentage + '%';

    progressText.textContent = text ? text : `${current}/${total} (${percentage}%)`;

    if (current >= total) setTimeout(() => hideProgress(), 2000);
  }

  // ===== INIT =====
  console.log('[INIT] DOMContentLoaded fired');
  document.addEventListener('DOMContentLoaded', async () => {
    console.log('[INIT] DOMContentLoaded callback started');
    // garante estado inicial
    recipients = [];
    updateRecipientsList();

    await loadStatus();
    connectWebSocket();

    initEmojiPicker();
    initDragDrop();

    // formata√ß√£o
    document.getElementById('boldBtn').addEventListener('click', (e) => { e.preventDefault(); surroundSelection('*'); });
    document.getElementById('italicBtn').addEventListener('click', (e) => { e.preventDefault(); surroundSelection('_'); });

    // ‚úÖ bot√µes recipients (sem inline onclick)
    const addBtn = document.getElementById('addRecipientBtn');
    const importBtn = document.getElementById('importContactsBtn');
    console.log('[INIT] addBtn found:', addBtn);
    console.log('[INIT] importBtn found:', importBtn);

    addBtn.addEventListener('click', (e) => { e.preventDefault(); addRecipient(); });
    importBtn.addEventListener('click', (e) => { e.preventDefault(); importContacts(); });
    console.log('[INIT] event listeners attached');

    // enter no input
    document.getElementById('recipientsInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addRecipient();
      }
    });

    // refresh QR
    document.getElementById('btnRefreshQR').addEventListener('click', async (e) => {
      e.preventDefault();
      await fetchAndShowQr();
    });

    // envio
    document.getElementById('messageForm').addEventListener('submit', async function(event) {
      event.preventDefault();

      updateHiddenTextarea();
      updateRecipientsHidden();

      const msg = document.getElementById('message').value;
      if (!msg || !msg.replace(/\s/g,'').length) {
        showMessageModal('ERRO', 'A MENSAGEM N√ÉO PODE SER VAZIA.', 'danger');
        return;
      }

      if (!recipients.length) {
        showMessageModal('ERRO', 'ADICIONE PELO MENOS 1 DESTINAT√ÅRIO.', 'danger');
        return;
      }

      const formData = new FormData(this);

      const submitButton = document.getElementById('btnSend');
      submitButton.disabled = true;
      const original = submitButton.textContent;
      submitButton.textContent = 'ENVIANDO...';

      try {
        const resp = await fetch('/api/send', { method: 'POST', body: formData });
        const data = await resp.json().catch(() => null);

        submitButton.disabled = false;
        submitButton.textContent = original;

        if (data && data.status === 'success') {
          showMessageModal('SUCESSO', data.message || 'MENSAGEM ENVIADA COM SUCESSO!', 'success');

          // limpar
          this.reset();
          document.getElementById('messageEditor').innerText = '';
          document.getElementById('filePreview').innerHTML = '';
          attachedFiles = [];
          recipients = [];
          updateRecipientsList();

        } else {
          const emsg = (data && (data.message || data.error)) ? (data.message || data.error) : 'FALHA AO ENVIAR.';
          showMessageModal('ERRO', 'ERRO AO ENVIAR MENSAGEM: ' + emsg, 'danger');
          console.error('Resposta:', data);
        }
      } catch (err) {
        submitButton.disabled = false;
        submitButton.textContent = original;
        console.error('Erro ao enviar:', err);
        showMessageModal('ERRO', 'ERRO AO ENVIAR MENSAGEM.', 'danger');
      }
    });
  });
</script>

</body>
</html>
