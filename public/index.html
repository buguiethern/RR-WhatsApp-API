<!-- public/index.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>WhatsApp API</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.19.0/index.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.19.0/index.js"></script>

  <style>
    body { background:#0a0a0a; color:#00ff88; font-family:'Courier New', monospace; }
    .container { margin-top:50px; }
    .card { background:#111; border:1px solid #00ff88; border-radius:0; box-shadow:0 0 20px rgba(0,255,136,.3); }
    .form-control,.form-control:focus { background:#1a1a1a; border:1px solid #00ff88; color:#00ff88; border-radius:0; }
    .form-control:focus { box-shadow:0 0 10px rgba(0,255,136,.5); }
    h1,h2,h3 { color:#00ff88; text-transform:uppercase; letter-spacing:1px; }

    .btn-primary { background:#00ff88; border-color:#00ff88; color:#000; text-transform:uppercase; letter-spacing:1px; border-radius:0; }
    .btn-primary:hover { background:#00cc66; border-color:#00cc66; box-shadow:0 0 15px rgba(0,255,136,.6); }

    .btn-outline-secondary { border-color:#00ff88; color:#00ff88; text-transform:uppercase; letter-spacing:1px; border-radius:0; }
    .btn-outline-secondary:hover { background:#00ff88; color:#000; }

    .btn-danger { background:#ff0040; border-color:#ff0040; color:#fff; text-transform:uppercase; letter-spacing:1px; border-radius:0; }
    .btn-danger:hover { background:#cc0033; border-color:#cc0033; }

    .btn-success { background:#00ff88; border-color:#00ff88; color:#000; text-transform:uppercase; letter-spacing:1px; border-radius:0; }
    .btn-success:hover { background:#00cc66; border-color:#00cc66; box-shadow:0 0 15px rgba(0,255,136,.6); }

    .btn-outline-danger { border-color:#ff0040; color:#ff0040; text-transform:uppercase; letter-spacing:1px; border-radius:0; }
    .btn-outline-danger:hover { background:#ff0040; color:#fff; }

    .muted { color:#666; font-size:.95em; }
    .loading { text-align:center; font-size:1.2em; color:#00ff88; }

    .qr-wrap { display:flex; justify-content:center; align-items:center; }
    #qrCode { width:260px; height:260px; border:2px solid #00ff88; image-rendering:pixelated; image-rendering:crisp-edges; }

    .message-editor {
      background:#1a1a1a; border:1px solid #00ff88; padding:10px; min-height:120px;
      resize:none; border-radius:0; color:#00ff88; white-space:pre-wrap; overflow-wrap:anywhere;
    }
    .message-editor:focus { outline:none; box-shadow:0 0 10px rgba(0,255,136,.5); }

    .format-toolbar { background:#111; border:1px solid #00ff88; padding:5px; margin-bottom:5px; position:relative; }
    .format-toolbar button { background:none; border:1px solid #00ff88; color:#00ff88; padding:5px 10px; margin-right:5px; text-transform:uppercase; letter-spacing:1px; border-radius:0; }
    .format-toolbar button:hover { background:#00ff88; color:#000; }

    .file-preview { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    .preview-item { position:relative; border:1px solid #00ff88; padding:10px; background:#1a1a1a; }
    .preview-item img,.preview-item video { max-width:100px; max-height:100px; }
    .preview-item .file-info { margin-top:5px; font-size:12px; text-align:center; }
    .preview-item .remove-preview { position:absolute; top:5px; right:5px; background:#ff0040; color:white; border:none; border-radius:50%; width:20px; height:20px; cursor:pointer; }

    .api-docs-btn { margin-top:30px; text-align:center; }
    .api-docs-btn button {
      background:#00ff88; border:2px solid #00ff88; color:#000; padding:15px 30px; text-transform:uppercase;
      letter-spacing:2px; font-weight:bold; font-size:18px; border-radius:0; cursor:pointer; box-shadow:0 0 20px rgba(0,255,136,.5);
    }
    .api-docs-btn button:hover { background:#000; color:#00ff88; transform:scale(1.05); transition:all .3s; }

    .recipients-list { display:flex; flex-wrap:wrap; gap:8px; min-height:60px; align-content:flex-start; }
    .recipient-tag { display:inline-flex; align-items:center; background:#00ff88; color:#000; padding:6px 12px; border-radius:0; font-size:14px; font-weight:bold; text-transform:uppercase; letter-spacing:1px; border:none; gap:8px; }
    .recipient-tag .tag-sub { font-weight:normal; font-size:12px; opacity:.85; text-transform:none; letter-spacing:0; }
    .recipient-tag .remove-tag { background:none; border:none; color:#000; margin-left:6px; cursor:pointer; font-size:16px; font-weight:bold; line-height:1; }
    .recipient-tag .remove-tag:hover { color:#660000; }

    .progress-bar-container { width:100%; height:34px; background:#1a1a1a; border:1px solid #00ff88; border-radius:0; overflow:hidden; margin:10px 0 6px 0; display:none; }
    .progress-bar-fill { height:100%; background:linear-gradient(90deg,#00ff88,#00cc66); width:0%; transition:width .15s ease; position:relative; }
    .progress-bar-text { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#000; font-weight:bold; font-size:13px; text-transform:uppercase; letter-spacing:1px; white-space:nowrap; }

    .send-controls { display:none; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .send-controls .mini { border:1px solid #00ff88; color:#00ff88; background:transparent; padding:8px 10px; border-radius:0; text-transform:uppercase; letter-spacing:1px; font-weight:bold; }
    .send-controls .mini:hover { background:#00ff88; color:#000; }
    .send-controls .mini-danger { border:1px solid #ff0040; color:#ff0040; }
    .send-controls .mini-danger:hover { background:#ff0040; color:#fff; }
    .send-controls .stat { color:#00ff88; font-size:12px; letter-spacing:1px; text-transform:uppercase; opacity:.9; }
    .send-controls .stat strong { color:#00ff88; font-size:13px; }

    .modal-content { background:#111; border:1px solid #00ff88; color:#00ff88; border-radius:0; }
    .modal-header { border-bottom:1px solid #00ff88; }
    .modal-footer { border-top:1px solid #00ff88; }
    .btn-close { filter:invert(1) hue-rotate(75deg); }

    .btn-mini {
      border:1px solid #00ff88; color:#00ff88; background:transparent; padding:10px 14px; border-radius:0;
      text-transform:uppercase; letter-spacing:1px; font-weight:bold; white-space:nowrap;
    }
    .btn-mini:hover { background:#00ff88; color:#000; }

    .panel-advanced { border:1px dashed #00ff88; padding:12px; background:#0f0f0f; }

    .kpi { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    .kpi .box { flex:1; min-width:180px; border:1px solid #00ff88; background:#111; padding:10px; }
    .kpi .title { color:#00ff88; font-weight:bold; text-transform:uppercase; font-size:12px; }
    .kpi .value { color:#00ff88; font-size:16px; margin-top:6px; white-space:pre-wrap; word-break:break-word; }
    .kpi .sub { color:#666; font-size:12px; margin-top:6px; }

    .sim-box { border:1px solid #00ff88; background:#111; padding:12px; margin-top:10px; }
    .sim-box pre { margin:0; white-space:pre-wrap; word-break:break-word; color:#00ff88; font-size:12px; }

    .pill { display:inline-block; padding:4px 8px; border:1px solid #00ff88; color:#00ff88; background:#0f0f0f; font-size:12px; text-transform:uppercase; letter-spacing:1px; margin-right:8px; margin-bottom:8px; }
  </style>
</head>
<body>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card p-4">
        <h1 class="text-center mb-4">> WHATSAPP API <</h1>

        <h2>> ENVIAR MENSAGEM</h2>

        <form id="messageForm" action="/api/send" method="POST" enctype="multipart/form-data" class="mb-4" accept-charset="UTF-8">
          <div class="mb-3">
            <label for="recipientsInput" class="form-label">DESTINAT√ÅRIOS</label>

            <div style="display:flex; gap:10px; margin-bottom:10px;">
              <input type="text" id="recipientsInput" class="form-control" placeholder="Digite telefone ou nome do grupo..." style="flex:1;">
              <button type="button" id="addRecipientBtn" class="btn-mini">+ ADICIONAR</button>
              <button type="button" id="importContactsBtn" class="btn-mini">üìÅ IMPORTAR JSON</button>
              <button type="button" id="toggleAdvancedBtn" class="btn-mini">‚öôÔ∏è AVAN√áADO</button>
            </div>

            <div class="kpi">
              <div class="box">
                <div class="title">CONTATOS NA LISTA</div>
                <div class="value" id="kpiCount">0</div>
                <div class="sub" id="kpiHint">Nenhum destinat√°rio adicionado</div>
              </div>
              <div class="box">
                <div class="title">PR√âVIA (1¬∫ DESTINAT√ÅRIO)</div>
                <div class="value" id="kpiPreview">(adicione destinat√°rios)</div>
                <div class="sub">vari√°veis: $nome, $email, $telefone, $telefone_formatado</div>
              </div>
            </div>

            <div id="recipientsList" class="recipients-list"
                 style="min-height:50px; border:1px solid #00ff88; padding:10px; border-radius:0; background:#1a1a1a; margin-top:10px;">
              <div class="muted" style="color:#666;">Nenhum destinat√°rio adicionado</div>
            </div>

            <input type="hidden" id="recipients" name="recipients" value="[]">
          </div>

          <div class="mb-3">
            <label for="countrySelect" class="form-label">PA√çS PARA FORMATA√á√ÉO</label>
            <select id="countrySelect" name="country" class="form-control">
              <option value="BR">üáßüá∑ BRASIL (+55)</option>
              <option value="US">üá∫üá∏ ESTADOS UNIDOS (+1)</option>
              <option value="OTHER">üåç OUTRO (SEM FORMATA√á√ÉO)</option>
            </select>
            <div class="muted mt-1">ESCOLHA O FORMATO QUE SER√Å APLICADO AOS TELEFONES.</div>
          </div>

          <div class="mb-3">
            <label for="message" class="form-label">MENSAGEM</label>
            <div class="format-toolbar">
              <button type="button" id="boldBtn">*</button>
              <button type="button" id="italicBtn">_</button>
              <button type="button" id="emojiBtn">üòÄ</button>
              <span id="emojiPicker" style="display:inline-block;"></span>
            </div>

            <div class="message-editor" id="messageEditor" contenteditable="true"></div>
            <textarea id="message" name="message" class="d-none"></textarea>

            <div class="muted mt-1">ARRASTE E SOLTE IMAGENS, PDFS OU VIDEOS AQUI.</div>
            <div class="file-preview" id="filePreview"></div>
          </div>

          <!-- ‚úÖ AVAN√áADO -->
          <div class="mb-3" id="advancedPanel" style="display:none;">
            <div class="panel-advanced">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                <h3 style="margin:0;">AVAN√áADO</h3>
                <div class="muted" id="advancedStatus">(simula√ß√£o autom√°tica)</div>
              </div>

              <div class="sim-box mt-3">
                <div class="pill" id="pillWindow">JANELA: 08:00‚Äì19:00</div>
                <div class="pill" id="pillDelay">DELAY: 45‚Äì110s</div>
                <div class="pill" id="pillBreak">PAUSA LONGA: a cada 25</div>
                <div class="pill" id="pillTotal">TOTAL: 0</div>
                <div class="pill" id="pillStart">IN√çCIO: --</div>
                <div class="pill" id="pillEnd">FIM: --</div>
              </div>

              <div class="row g-2 mt-2">
                <div class="col-md-3">
                  <label class="form-label muted">JANELA IN√çCIO</label>
                  <input type="time" class="form-control" id="windowStart" value="08:00">
                </div>
                <div class="col-md-3">
                  <label class="form-label muted">JANELA FIM</label>
                  <input type="time" class="form-control" id="windowEnd" value="19:00">
                </div>

                <div class="col-md-3">
                  <label class="form-label muted">DELAY M√çN (SEG)</label>
                  <input type="number" class="form-control" id="delayMinSec" value="45" min="0" max="600" step="1">
                </div>
                <div class="col-md-3">
                  <label class="form-label muted">DELAY M√ÅX (SEG)</label>
                  <input type="number" class="form-control" id="delayMaxSec" value="110" min="0" max="600" step="1">
                </div>

                <div class="col-md-4">
                  <label class="form-label muted">PAUSA LONGA A CADA (msgs)</label>
                  <input type="number" class="form-control" id="longEvery" value="25" min="0" max="5000" step="1">
                </div>
                <div class="col-md-4">
                  <label class="form-label muted">PAUSA LONGA M√çN (min)</label>
                  <input type="number" class="form-control" id="longMinMin" value="10" min="0" max="360" step="1">
                </div>
                <div class="col-md-4">
                  <label class="form-label muted">PAUSA LONGA M√ÅX (min)</label>
                  <input type="number" class="form-control" id="longMaxMin" value="20" min="0" max="360" step="1">
                </div>
              </div>

              <div class="muted mt-2">
                <div>‚Ä¢ A simula√ß√£o considera o n√∫mero de contatos atual.</div>
                <div>‚Ä¢ Mostra estimativa M√çN / M√âDIA / M√ÅX e respeita a janela (se estourar, continua no pr√≥ximo dia).</div>
              </div>

              <div class="sim-box mt-3">
                <div class="title" style="color:#00ff88; font-weight:bold; text-transform:uppercase; font-size:12px;">SIMULA√á√ÉO</div>
                <pre id="simulationText">Adicione destinat√°rios para simular.</pre>
              </div>

              <div class="sim-box mt-3">
                <div class="title" style="color:#00ff88; font-weight:bold; text-transform:uppercase; font-size:12px;">EXEMPLO DE APLICA√á√ÉO DE VARI√ÅVEIS (1¬∫ DESTINAT√ÅRIO)</div>
                <pre id="previewAdvanced">(adicione destinat√°rios)</pre>
              </div>

              <div class="mt-3" style="display:flex; gap:10px; flex-wrap:wrap;">
                <button type="button" class="btn btn-success" id="btnSavePlan" style="flex:1; min-width:220px;">SALVAR CONFIGURA√á√ÉO</button>
                <button type="button" class="btn btn-outline-secondary" id="btnLoadPlan" style="flex:1; min-width:220px;">CARREGAR CONFIGURA√á√ÉO</button>
                <button type="button" class="btn btn-outline-danger" id="btnResetPlan" style="flex:1; min-width:220px;">RESETAR PADR√ÉO</button>
              </div>

              <div class="muted mt-2" id="planSaveHint">A configura√ß√£o salva fica no navegador (localStorage) e tamb√©m pode ser enviada ao backend se existir /api/plan.</div>
            </div>
          </div>

          <input type="hidden" id="planInput" name="plan" value="">
          <input type="hidden" id="delayInput" name="delay" value="1.2">

          <div class="send-controls" id="sendControls">
            <button type="button" class="mini" id="btnPauseSend">PAUSAR</button>
            <button type="button" class="mini" id="btnResumeSend" style="display:none;">RETOMAR</button>
            <button type="button" class="mini mini-danger" id="btnCancelSend">CANCELAR</button>

            <div class="stat">
              ENVIADAS: <strong id="statSent">0</strong> /
              TOTAL: <strong id="statTotal">0</strong> ‚Ä¢
              FALHAS: <strong id="statFail">0</strong> ‚Ä¢
              STATUS: <strong id="statState">-</strong>
            </div>
          </div>

          <div class="progress-bar-container" id="progressContainer">
            <div class="progress-bar-fill" id="progressBar">
              <div class="progress-bar-text" id="progressText">AGUARDANDO...</div>
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100" id="btnSend">> ENVIAR MENSAGEM</button>
        </form>

        <hr class="my-4">

        <h2 id="connectionStatus" class="text-center">CARREGANDO STATUS...</h2>
        <div id="connectBtn" class="text-center mt-3"></div>
        <div class="muted text-center mt-3" id="stateHint"></div>

        <div class="api-docs-btn">
          <button type="button" onclick="window.open('doc.html','_blank')">> DOCUMENTA√á√ÉO DA API</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="qrModalLabel">CONECTAR AO WHATSAPP</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <h6>ESCANEIE O QR CODE ABAIXO:</h6>

        <div id="qrCodeContainer" class="mt-3">
          <div class="loading" id="loadingMessage">CARREGANDO QR CODE...</div>

          <div class="qr-wrap mt-2">
            <img id="qrCode" src="" alt="QR Code" style="display:none;">
          </div>

          <div class="muted mt-3" id="qrHint" style="display:none;">SE EXPIRAR, CLIQUE EM "ATUALIZAR QR".</div>

          <button class="btn btn-outline-secondary w-100 mt-3" id="btnRefreshQR" type="button">ATUALIZAR QR</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="messageModalLabel">MENSAGEM</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="messageModalBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">FECHAR</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/config.js"></script>

<script>
  let qrModalInstance = null;
  let ws = null;
  let attachedFiles = [];
  let recipients = [];

  // status do job atual no front
  let currentJobId = null;
  let currentJobState = 'IDLE';

  function escapeHtml(str) {
    return String(str ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  function showMessageModal(title, message, type) {
    const messageModalLabel = document.getElementById('messageModalLabel');
    const messageModalBody = document.getElementById('messageModalBody');
    if (typeof bootstrap === 'undefined') {
      alert(`${title}: ${message}`);
      return;
    }
    messageModalLabel.textContent = title;
    messageModalBody.innerHTML = `<div class="alert alert-${type}" role="alert">${escapeHtml(message)}</div>`;
    const messageModal = new bootstrap.Modal(document.getElementById('messageModal'));
    messageModal.show();
  }

  // =========== TEXT/VARS ===========
  function normalizeNewlines(s) {
    let t = String(s ?? '');
    t = t.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    t = t.replace(/\u2028|\u2029/g, '\n');
    t = t.replace(/\u00A0/g, ' ');
    t = t.replace(/[ \t]+\n/g, '\n');
    return t;
  }

  function applyTemplateVars(text, vars) {
    const src = normalizeNewlines(text);
    const dict = {};
    if (vars && typeof vars === 'object') {
      for (const [k, v] of Object.entries(vars)) {
        const key = String(k || '').trim().toLowerCase();
        if (!key) continue;
        if (v === null || v === undefined) continue;
        dict[key] = (typeof v === 'string') ? v : String(v);
      }
    }
    return src.replace(/\$([a-zA-Z0-9_]+)/g, (m, k) => {
      const key = String(k).toLowerCase();
      return (dict[key] !== undefined) ? dict[key] : m;
    });
  }

  function getEditorPlainTextPreserveLines() {
    const editor = document.getElementById('messageEditor');
    let t = editor.innerText || '';
    t = t.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    t = t.replace(/\u2028|\u2029/g, '\n');
    t = t.replace(/\u00A0/g, ' ');
    t = t.replace(/[ \t]+\n/g, '\n');
    return t;
  }

  function updateHiddenTextarea() {
    document.getElementById('message').value = getEditorPlainTextPreserveLines();
  }

  function surroundSelection(prefix) {
    const editor = document.getElementById('messageEditor');
    editor.focus();
    const sel = window.getSelection();
    if (!sel || sel.rangeCount === 0) return;
    const range = sel.getRangeAt(0);
    if (!editor.contains(range.commonAncestorContainer)) return;
    const selected = range.toString();
    const insert = prefix + selected + prefix;
    range.deleteContents();
    range.insertNode(document.createTextNode(insert));
  }

  function insertAtCursor(text) {
    const editor = document.getElementById('messageEditor');
    editor.focus();
    const sel = window.getSelection();
    if (!sel || sel.rangeCount === 0) {
      editor.appendChild(document.createTextNode(text));
      return;
    }
    const range = sel.getRangeAt(0);
    if (!editor.contains(range.commonAncestorContainer)) {
      editor.appendChild(document.createTextNode(text));
      return;
    }
    range.deleteContents();
    range.insertNode(document.createTextNode(text));
    range.collapse(false);
    sel.removeAllRanges();
    sel.addRange(range);
  }

  function initEmojiPicker() {
    const picker = new EmojiPicker();
    const emojiBtn = document.getElementById('emojiBtn');
    const container = document.getElementById('emojiPicker');

    container.appendChild(picker);

    picker.style.display = 'none';
    picker.style.position = 'absolute';
    picker.style.right = '0';
    picker.style.top = '38px';
    picker.style.zIndex = '1000';

    emojiBtn.addEventListener('click', (e) => {
      e.preventDefault();
      picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
    });

    picker.addEventListener('emoji-click', (event) => {
      const emoji = event.detail.emoji.unicode;
      insertAtCursor(emoji);
      picker.style.display = 'none';
    });

    document.addEventListener('click', (e) => {
      if (e.target === emojiBtn) return;
      if (container.contains(e.target)) return;
      picker.style.display = 'none';
    });
  }

  // =========== ADVANCED UI + SAVE/LOAD ===========
  const PLAN_STORAGE_KEY = 'WA_SEND_PLAN_V1';

  function toggleAdvanced() {
    const panel = document.getElementById('advancedPanel');
    const btn = document.getElementById('toggleAdvancedBtn');
    const open = panel.style.display !== 'none';
    panel.style.display = open ? 'none' : 'block';
    btn.textContent = open ? '‚öôÔ∏è AVAN√áADO' : '‚úñ FECHAR AVAN√áADO';
    if (!open) {
      refreshSimulation();
      refreshPreviewKpis();
    }
  }

  function timeToMin(hhmm) {
    const m = String(hhmm || '').trim().match(/^(\d{1,2}):(\d{2})$/);
    if (!m) return 0;
    const hh = Math.max(0, Math.min(23, Number(m[1])));
    const mm = Math.max(0, Math.min(59, Number(m[2])));
    return hh * 60 + mm;
  }

  function fmtHHMM(d) {
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    return `${hh}:${mm}`;
  }

  function fmtDateTime(d) {
    const dd = String(d.getDate()).padStart(2, '0');
    const mo = String(d.getMonth() + 1).padStart(2, '0');
    const yyyy = d.getFullYear();
    return `${dd}/${mo}/${yyyy} ${fmtHHMM(d)}`;
  }

  function isWithinWindow(minNow, minStart, minEnd) {
    if (minStart === minEnd) return true;
    if (minStart < minEnd) return (minNow >= minStart && minNow < minEnd);
    return (minNow >= minStart || minNow < minEnd);
  }

  function nextWindowStart(fromDate, minStart, minEnd) {
    const d = new Date(fromDate.getTime());
    const nowMin = d.getHours() * 60 + d.getMinutes();

    if (minStart < minEnd) {
      if (nowMin < minStart) {
        d.setHours(Math.floor(minStart / 60), minStart % 60, 0, 0);
        return d;
      }
      if (nowMin >= minEnd) {
        d.setDate(d.getDate() + 1);
        d.setHours(Math.floor(minStart / 60), minStart % 60, 0, 0);
        return d;
      }
      d.setSeconds(0, 0);
      return d;
    }

    const inWin = isWithinWindow(nowMin, minStart, minEnd);
    if (inWin) { d.setSeconds(0, 0); return d; }
    d.setHours(Math.floor(minStart / 60), minStart % 60, 0, 0);
    return d;
  }

  function consumeWorkTime(startDate, minStart, minEnd, workMs) {
    let cur = new Date(startDate.getTime());
    let remain = Math.max(0, Number(workMs || 0));

    while (remain > 0) {
      const curMin = cur.getHours() * 60 + cur.getMinutes();

      if (!isWithinWindow(curMin, minStart, minEnd)) {
        cur = nextWindowStart(cur, minStart, minEnd);
        continue;
      }

      let endToday = new Date(cur.getTime());
      if (minStart < minEnd) {
        endToday.setHours(Math.floor(minEnd / 60), minEnd % 60, 0, 0);
      } else {
        if (curMin >= minStart) {
          endToday.setDate(endToday.getDate() + 1);
          endToday.setHours(Math.floor(minEnd / 60), minEnd % 60, 0, 0);
        } else {
          endToday.setHours(Math.floor(minEnd / 60), minEnd % 60, 0, 0);
        }
      }

      const avail = Math.max(0, endToday.getTime() - cur.getTime());

      if (remain <= avail) {
        cur = new Date(cur.getTime() + remain);
        remain = 0;
        break;
      } else {
        cur = new Date(endToday.getTime() + 1000);
        remain -= avail;
      }
    }

    return cur;
  }

  function estimateWorkMs(n, plan, mode) {
    const total = Math.max(0, Number(n || 0));
    if (total <= 1) return 0;

    const gaps = total - 1;

    const dMin = Math.max(0, Number(plan.delay_min_ms || 0));
    const dMax = Math.max(dMin, Number(plan.delay_max_ms || 0));
    const dAvg = Math.round((dMin + dMax) / 2);

    const every = Math.max(0, Number(plan.long_break_every || 0));
    const lbMin = Math.max(0, Number(plan.long_break_min_ms || 0));
    const lbMax = Math.max(lbMin, Number(plan.long_break_max_ms || 0));
    const lbAvg = Math.round((lbMin + lbMax) / 2);

    const longBreaks = (every > 0) ? Math.floor((gaps) / every) : 0;

    const delayPer = (mode === 'min') ? dMin : (mode === 'max') ? dMax : dAvg;
    const breakPer = (mode === 'min') ? lbMin : (mode === 'max') ? lbMax : lbAvg;

    return (gaps * delayPer) + (longBreaks * breakPer);
  }

  function fmtDuration(ms) {
    let s = Math.max(0, Math.floor(ms / 1000));
    const days = Math.floor(s / 86400); s -= days * 86400;
    const hh = Math.floor(s / 3600); s -= hh * 3600;
    const mm = Math.floor(s / 60); s -= mm * 60;

    const parts = [];
    if (days) parts.push(`${days}d`);
    if (hh || days) parts.push(`${String(hh).padStart(2,'0')}h`);
    parts.push(`${String(mm).padStart(2,'0')}m`);
    parts.push(`${String(s).padStart(2,'0')}s`);
    return parts.join(' ');
  }

  function buildExampleTimeline(n, plan, sampleCount = 10) {
    const total = Math.max(0, Number(n || 0));
    if (total <= 1) return [];

    const gaps = total - 1;
    const take = Math.min(gaps, sampleCount);

    const dMin = Math.max(0, Number(plan.delay_min_ms || 0));
    const dMax = Math.max(dMin, Number(plan.delay_max_ms || 0));

    const every = Math.max(0, Number(plan.long_break_every || 0));
    const lbMin = Math.max(0, Number(plan.long_break_min_ms || 0));
    const lbMax = Math.max(lbMin, Number(plan.long_break_max_ms || 0));

    function randInt(a, b) {
      a = Math.ceil(a); b = Math.floor(b);
      if (b <= a) return a;
      return Math.floor(Math.random() * (b - a + 1)) + a;
    }

    const arr = [];
    for (let i = 1; i <= take; i++) {
      const isLong = (every > 0) ? (i % every === 0) : false;
      if (isLong) arr.push({ kind: 'PAUSA_LONGA', ms: randInt(lbMin, lbMax) });
      else arr.push({ kind: 'DELAY', ms: randInt(dMin, dMax) });
    }
    return arr;
  }

  function buildPlanPayload() {
    const wsVal = document.getElementById('windowStart').value || '08:00';
    const weVal = document.getElementById('windowEnd').value || '19:00';

    const dmin = Math.max(0, Number(document.getElementById('delayMinSec').value || 45));
    const dmax = Math.max(dmin, Number(document.getElementById('delayMaxSec').value || 110));

    const every = Math.max(0, Number(document.getElementById('longEvery').value || 25));
    const lmin = Math.max(0, Number(document.getElementById('longMinMin').value || 10));
    const lmax = Math.max(lmin, Number(document.getElementById('longMaxMin').value || 20));

    return {
      window_start: wsVal,
      window_end: weVal,
      delay_min_ms: Math.round(dmin * 1000),
      delay_max_ms: Math.round(dmax * 1000),
      long_break_every: every,
      long_break_min_ms: Math.round(lmin * 60 * 1000),
      long_break_max_ms: Math.round(lmax * 60 * 1000),
      hard_stop_outside_window: false
    };
  }

  function applyPlanToInputs(plan) {
    if (!plan || typeof plan !== 'object') return;

    if (plan.window_start) document.getElementById('windowStart').value = plan.window_start;
    if (plan.window_end) document.getElementById('windowEnd').value = plan.window_end;

    if (Number.isFinite(plan.delay_min_ms)) document.getElementById('delayMinSec').value = Math.round(plan.delay_min_ms / 1000);
    if (Number.isFinite(plan.delay_max_ms)) document.getElementById('delayMaxSec').value = Math.round(plan.delay_max_ms / 1000);

    if (Number.isFinite(plan.long_break_every)) document.getElementById('longEvery').value = plan.long_break_every;
    if (Number.isFinite(plan.long_break_min_ms)) document.getElementById('longMinMin').value = Math.round(plan.long_break_min_ms / 60000);
    if (Number.isFinite(plan.long_break_max_ms)) document.getElementById('longMaxMin').value = Math.round(plan.long_break_max_ms / 60000);

    refreshSimulation();
  }

  function savePlanLocal(plan) { localStorage.setItem(PLAN_STORAGE_KEY, JSON.stringify(plan)); }
  function loadPlanLocal() {
    const raw = localStorage.getItem(PLAN_STORAGE_KEY);
    if (!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
  }

  async function trySavePlanBackend(plan) {
    try {
      const resp = await fetch('/api/plan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(plan)
      });
      if (!resp.ok) return false;
      const data = await resp.json().catch(() => null);
      if (!data) return true;
      if (data.status && data.status !== 'success') return false;
      return true;
    } catch {
      return false;
    }
  }

  async function tryLoadPlanBackend() {
    try {
      const resp = await fetch('/api/plan', { cache: 'no-store' });
      if (!resp.ok) return null;
      return await resp.json();
    } catch {
      return null;
    }
  }

  async function onSavePlanClick() {
    const plan = buildPlanPayload();
    savePlanLocal(plan);
    const okServer = await trySavePlanBackend(plan);

    showMessageModal(
      'CONFIGURA√á√ÉO SALVA',
      okServer
        ? 'SALVO NO NAVEGADOR E NO SERVIDOR.'
        : 'SALVO NO NAVEGADOR. (BACKEND /api/plan N√ÉO RESPONDEU OU N√ÉO EXISTE)',
      okServer ? 'success' : 'info'
    );

    refreshSimulation();
  }

  async function onLoadPlanClick() {
    const serverPlan = await tryLoadPlanBackend();
    if (serverPlan && typeof serverPlan === 'object') {
      applyPlanToInputs(serverPlan);
      savePlanLocal(serverPlan);
      showMessageModal('CONFIGURA√á√ÉO', 'CARREGADA DO SERVIDOR E APLICADA.', 'success');
      return;
    }

    const localPlan = loadPlanLocal();
    if (localPlan) {
      applyPlanToInputs(localPlan);
      showMessageModal('CONFIGURA√á√ÉO', 'CARREGADA DO NAVEGADOR E APLICADA.', 'success');
      return;
    }

    showMessageModal('CONFIGURA√á√ÉO', 'NENHUMA CONFIGURA√á√ÉO SALVA ENCONTRADA.', 'warning');
  }

  async function onResetPlanClick() {
    const def = {
      window_start: '08:00',
      window_end: '19:00',
      delay_min_ms: 45000,
      delay_max_ms: 110000,
      long_break_every: 25,
      long_break_min_ms: 10 * 60 * 1000,
      long_break_max_ms: 20 * 60 * 1000,
      hard_stop_outside_window: false
    };
    applyPlanToInputs(def);
    savePlanLocal(def);
    await trySavePlanBackend(def).catch(() => {});
    showMessageModal('CONFIGURA√á√ÉO', 'RESETADO PARA O PADR√ÉO.', 'success');
  }

  // =========== SIMULA√á√ÉO ===========
  function refreshPreviewKpis() {
    const msg = getEditorPlainTextPreserveLines();
    const first = recipients[0] || null;

    document.getElementById('kpiCount').textContent = String(recipients.length);

    if (!recipients.length) {
      document.getElementById('kpiHint').textContent = 'Nenhum destinat√°rio adicionado';
      document.getElementById('kpiPreview').textContent = '(adicione destinat√°rios)';
      document.getElementById('previewAdvanced').textContent = '(adicione destinat√°rios)';
      return;
    }

    document.getElementById('kpiHint').textContent = `Pronto para enviar para ${recipients.length} contato(s).`;

    const vars = (first && first.vars && typeof first.vars === 'object') ? first.vars : {};
    const preview = applyTemplateVars(msg, vars);
    const safePreview = preview.trim().length ? preview : '(mensagem vazia)';
    document.getElementById('kpiPreview').textContent = safePreview.slice(0, 180) + (safePreview.length > 180 ? '...' : '');
    document.getElementById('previewAdvanced').textContent = safePreview;
  }

  function refreshSimulation() {
    const panel = document.getElementById('advancedPanel');
    if (panel.style.display === 'none') return;

    const plan = buildPlanPayload();
    const n = recipients.length;

    const startMin = timeToMin(plan.window_start);
    const endMin = timeToMin(plan.window_end);

    const now = new Date();
    const startAt = nextWindowStart(now, startMin, endMin);

    const msMin = estimateWorkMs(n, plan, 'min');
    const msAvg = estimateWorkMs(n, plan, 'avg');
    const msMax = estimateWorkMs(n, plan, 'max');

    const endAtMin = consumeWorkTime(startAt, startMin, endMin, msMin);
    const endAtAvg = consumeWorkTime(startAt, startMin, endMin, msAvg);
    const endAtMax = consumeWorkTime(startAt, startMin, endMin, msMax);

    document.getElementById('pillWindow').textContent = `JANELA: ${plan.window_start}‚Äì${plan.window_end}`;
    document.getElementById('pillDelay').textContent = `DELAY: ${Math.round(plan.delay_min_ms/1000)}‚Äì${Math.round(plan.delay_max_ms/1000)}s`;
    document.getElementById('pillBreak').textContent = `PAUSA LONGA: a cada ${plan.long_break_every || 0}`;
    document.getElementById('pillTotal').textContent = `TOTAL: ${n}`;
    document.getElementById('pillStart').textContent = `IN√çCIO: ${fmtDateTime(startAt)}`;
    document.getElementById('pillEnd').textContent = `FIM: ${n <= 1 ? fmtDateTime(startAt) : fmtDateTime(endAtAvg)}`;

    const sim = document.getElementById('simulationText');

    if (!n) {
      sim.textContent = 'Adicione destinat√°rios para simular.';
      document.getElementById('advancedStatus').textContent = '(simula√ß√£o autom√°tica)';
      return;
    }

    const longBreaks = (() => {
      if (n <= 1) return 0;
      const gaps = n - 1;
      const every = Math.max(0, Number(plan.long_break_every || 0));
      if (!every) return 0;
      return Math.floor(gaps / every);
    })();

    const timeline = buildExampleTimeline(n, plan, 12);
    const timelineText = timeline.map((x, idx) => {
      const t = fmtDuration(x.ms);
      const tag = x.kind === 'PAUSA_LONGA' ? 'PAUSA LONGA' : 'DELAY';
      return `${String(idx+1).padStart(2,'0')}. ${tag}: ${t}`;
    }).join('\n');

    const lines = [];
    lines.push(`CONTATOS: ${n}`);
    lines.push(`JANELA: ${plan.window_start}‚Äì${plan.window_end}`);
    lines.push(`IN√çCIO ESTIMADO: ${fmtDateTime(startAt)}`);
    lines.push(`PAUSAS LONGAS (aprox.): ${longBreaks}`);
    lines.push('');
    lines.push(`DURA√á√ÉO (M√çN):   ${fmtDuration(msMin)}   -> FIM: ${fmtDateTime(endAtMin)}`);
    lines.push(`DURA√á√ÉO (M√âDIA): ${fmtDuration(msAvg)}   -> FIM: ${fmtDateTime(endAtAvg)}`);
    lines.push(`DURA√á√ÉO (M√ÅX):   ${fmtDuration(msMax)}   -> FIM: ${fmtDateTime(endAtMax)}`);
    lines.push('');
    lines.push('EXEMPLO (primeiros intervalos):');
    lines.push(timelineText || '(sem intervalos)');

    sim.textContent = lines.join('\n');
    document.getElementById('advancedStatus').textContent = `(atualizado: ${fmtHHMM(new Date())})`;
  }

  function bindSimulationInputs() {
    const ids = ['windowStart','windowEnd','delayMinSec','delayMaxSec','longEvery','longMinMin','longMaxMin'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('input', () => { refreshSimulation(); });
      el.addEventListener('change', () => { refreshSimulation(); });
    });
  }

  // =========== STATUS/QR ===========
  async function loadStatus() {
    try {
      const r = await fetch('/api/status', { cache: 'no-store' });
      const data = await r.json();

      const connectionStatus = document.getElementById('connectionStatus');
      const connectBtn = document.getElementById('connectBtn');
      const stateHint = document.getElementById('stateHint');

      if (data.status === 'connected') {
        connectionStatus.textContent = `CONECTADO AO WHATSAPP: ${data.number || ''}`.trim();
        stateHint.textContent = data.state ? `ESTADO: ${data.state}` : '';
        connectBtn.innerHTML = `
          <div class="btn-row" style="display:flex; gap:10px;">
            <button style="flex:1;" class="btn btn-danger" id="btnDisconnect">DESCONECTAR</button>
            <button style="flex:1;" class="btn btn-outline-danger" id="btnReset">RESETAR SESS√ÉO</button>
          </div>
        `;

        document.getElementById('btnDisconnect').addEventListener('click', disconnect);
        document.getElementById('btnReset').addEventListener('click', resetSession);
      } else {
        connectionStatus.textContent = 'N√ÉO CONECTADO AO WHATSAPP';
        stateHint.textContent = data.state ? `ESTADO: ${data.state}` : '';
        connectBtn.innerHTML = `
          <div class="btn-row" style="display:flex; gap:10px;">
            <button style="flex:1;" class="btn btn-success" id="btnConnect">CONECTAR</button>
            <button style="flex:1;" class="btn btn-outline-danger" id="btnReset">RESETAR SESS√ÉO</button>
          </div>
        `;

        document.getElementById('btnConnect').addEventListener('click', showQrCode);
        document.getElementById('btnReset').addEventListener('click', resetSession);
      }
    } catch (err) {
      console.error('Erro ao verificar status:', err);
      document.getElementById('connectionStatus').textContent = 'ERRO AO CARREGAR O STATUS';
    }
  }

  async function fetchAndShowQr() {
    const loadingMessage = document.getElementById('loadingMessage');
    const qrCode = document.getElementById('qrCode');
    const qrHint = document.getElementById('qrHint');

    loadingMessage.style.display = 'block';
    qrCode.style.display = 'none';
    qrHint.style.display = 'none';
    loadingMessage.textContent = 'CARREGANDO QR CODE...';

    try {
      const r = await fetch('/api/qr', { cache: 'no-store' });

      if (!r.ok) {
        const txt = await r.text().catch(() => '');
        loadingMessage.textContent = `ERRO HTTP ${r.status}: ${txt || 'falha ao buscar QR'}`;
        return;
      }

      const ct = (r.headers.get('content-type') || '').toLowerCase();

      if (ct.includes('application/json')) {
        const data = await r.json();
        if (data.status === 'connected') {
          loadingMessage.style.display = 'none';
          showMessageModal('Info', data.message || 'J√Å CONECTADO.', 'info');
          if (qrModalInstance) qrModalInstance.hide();
          await loadStatus();
          return;
        }
        if (data.status === 'waiting') {
          loadingMessage.textContent = data.message || 'AGUARDANDO GERAR QR...';
          return;
        }
        loadingMessage.textContent = data.message || 'ERRO AO GERAR QR.';
        return;
      }

      const blob = await r.blob();
      const url = URL.createObjectURL(blob);

      qrCode.src = url;
      loadingMessage.style.display = 'none';
      qrCode.style.display = 'block';
      qrHint.style.display = 'block';
    } catch (err) {
      console.error('Erro ao carregar QR:', err);
      loadingMessage.textContent = 'ERRO AO CARREGAR QR CODE.';
    }
  }

  function showQrCode() {
    if (typeof bootstrap === 'undefined') {
      alert('Erro: Bootstrap n√£o carregado, n√£o √© poss√≠vel mostrar QR.');
      return;
    }
    qrModalInstance = new bootstrap.Modal(document.getElementById('qrModal'));
    qrModalInstance.show();
    fetchAndShowQr();
  }

  async function disconnect() {
    try {
      await fetch('/api/disconnect', { cache: 'no-store' });
      showMessageModal('DESCONECTADO', 'DESCONECTADO E REINICIALIZADO!', 'warning');
      document.getElementById('messageModal').addEventListener('hidden.bs.modal', async () => {
        await loadStatus();
      }, { once: true });
    } catch (err) {
      console.error('Erro ao desconectar:', err);
      showMessageModal('ERRO', 'ERRO AO DESCONECTAR.', 'danger');
    }
  }

  async function resetSession() {
    try {
      const r = await fetch('/api/reset', { cache: 'no-store' });
      const txt = await r.text().catch(() => '');
      showMessageModal('SESS√ÉO', txt || 'SESS√ÉO RESETADA! GERE NOVO QR.', 'warning');
      document.getElementById('messageModal').addEventListener('hidden.bs.modal', async () => {
        await loadStatus();
      }, { once: true });
    } catch (err) {
      console.error('Erro ao resetar sess√£o:', err);
      showMessageModal('ERRO', 'ERRO AO RESETAR SESS√ÉO.', 'danger');
    }
  }

  // =========== SEND CONTROLS (PAUSE/RESUME/CANCEL) ===========
  function setSendControlsVisible(visible) {
    const box = document.getElementById('sendControls');
    box.style.display = visible ? 'flex' : 'none';
  }

  function setSendStateUI(state) {
    currentJobState = state || 'IDLE';
    document.getElementById('statState').textContent = currentJobState;

    const btnPause = document.getElementById('btnPauseSend');
    const btnResume = document.getElementById('btnResumeSend');

    if (currentJobState === 'PAUSED' || currentJobState === 'WAIT_WINDOW') {
      btnPause.style.display = 'none';
      btnResume.style.display = 'inline-block';
    } else if (currentJobState === 'RUNNING') {
      btnPause.style.display = 'inline-block';
      btnResume.style.display = 'none';
    } else {
      btnPause.style.display = 'inline-block';
      btnResume.style.display = 'none';
    }
  }

  function setSendStats(sent, total, fail) {
    document.getElementById('statSent').textContent = String(sent ?? 0);
    document.getElementById('statTotal').textContent = String(total ?? 0);
    document.getElementById('statFail').textContent = String(fail ?? 0);
  }

  async function sendControl(action) {
    try {
      const r = await fetch('/api/send-control', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, jobId: currentJobId })
      });
      const j = await r.json().catch(() => null);
      if (!r.ok || !j || j.status !== 'success') {
        showMessageModal('ERRO', (j && (j.message || j.error)) ? (j.message || j.error) : 'FALHA AO CONTROLAR ENVIO.', 'danger');
        return;
      }
    } catch (e) {
      showMessageModal('ERRO', 'FALHA AO CONTROLAR ENVIO.', 'danger');
    }
  }

  // =========== WEBSOCKET ===========
  function connectWebSocket() {
    try {
      const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
      const host = location.hostname;
      const wsPort = window.__WS_PORT__ ? `:${window.__WS_PORT__}` : (location.port ? `:${location.port}` : '');
      const wsUrl = `${protocol}://${host}${wsPort}`;

      ws = new WebSocket(wsUrl);

      ws.onopen = () => console.log('[WS] conectado:', wsUrl);
      ws.onclose = () => {
        console.log('[WS] desconectado, tentando reconectar...');
        setTimeout(connectWebSocket, 1500);
      };
      ws.onerror = (e) => console.log('[WS] erro:', e);

      ws.onmessage = async (event) => {
        let data;
        try { data = JSON.parse(event.data); } catch { return; }

        if (data.type === 'qr') {
          if (typeof bootstrap !== 'undefined') {
            if (!qrModalInstance) qrModalInstance = new bootstrap.Modal(document.getElementById('qrModal'));
            qrModalInstance.show();
            await fetchAndShowQr();
          }
        }

        if (data.type === 'authenticated' || data.type === 'ready') {
          if (qrModalInstance) qrModalInstance.hide();
          await loadStatus();
        }

        if (data.type === 'disconnected') await loadStatus();

        if (data.type === 'change_state' || data.type === 'state') {
          const stateHint = document.getElementById('stateHint');
          if (data.state) stateHint.textContent = `ESTADO: ${data.state}`;
        }

        // ======= JOB EVENTS (real-time) =======
        if (data.type === 'send_job') {
          currentJobId = data.jobId || null;

          if (data.event === 'queued') {
            setSendControlsVisible(true);
            setSendStateUI('QUEUED');
            setSendStats(0, data.total || 0, 0);
            showProgress();
            updateProgress(0, data.total || 1, 'ENFILEIRADO...');
          }

          if (data.event === 'started') {
            setSendControlsVisible(true);
            setSendStateUI('RUNNING');
            setSendStats(data.success || 0, data.total || 0, data.failed || 0);
            showProgress();
            updateProgress(data.current || 0, data.total || 1, 'INICIANDO...');
          }

          if (data.event === 'paused') {
            setSendControlsVisible(true);
            setSendStateUI('PAUSED');
            setSendStats(data.success || 0, data.total || 0, data.failed || 0);
            showProgress();
            updateProgress(data.current || 0, data.total || 1, data.message || 'PAUSADO');
          }

          if (data.event === 'resumed') {
            setSendControlsVisible(true);
            setSendStateUI('RUNNING');
            setSendStats(data.success || 0, data.total || 0, data.failed || 0);
          }

          if (data.event === 'wait_window') {
            setSendControlsVisible(true);
            setSendStateUI('WAIT_WINDOW');
            setSendStats(data.success || 0, data.total || 0, data.failed || 0);
            showProgress();
            updateProgress(data.current || 0, data.total || 1, data.message || 'FORA DA JANELA...');
          }

          if (data.event === 'tick') {
            setSendControlsVisible(true);
            setSendStateUI(data.state || 'RUNNING');
            setSendStats(data.success || 0, data.total || 0, data.failed || 0);
            showProgress();

            const label = data.label || data.recipient || data.message || '';
            const text = label ? `${data.current || 0}/${data.total || 0} ‚Ä¢ ${label}` : `${data.current || 0}/${data.total || 0}`;
            updateProgress(data.current || 0, data.total || 1, text);
          }

          if (data.event === 'completed') {
            setSendControlsVisible(false);
            setSendStateUI('DONE');
            setSendStats(data.success || 0, data.total || 0, data.failed || 0);
            showProgress();
            updateProgress(data.total || 1, data.total || 1, `${data.success || 0}/${data.total || 0} ‚Ä¢ CONCLU√çDO`);
            setTimeout(() => {
              const submitButton = document.getElementById('btnSend');
              submitButton.disabled = false;
              submitButton.textContent = '> ENVIAR MENSAGEM';
            }, 800);
          }

          if (data.event === 'canceled') {
            setSendControlsVisible(false);
            setSendStateUI('CANCELED');
            setSendStats(data.success || 0, data.total || 0, data.failed || 0);
            showProgress();
            updateProgress(data.current || 0, data.total || 1, 'CANCELADO');
            setTimeout(() => {
              const submitButton = document.getElementById('btnSend');
              submitButton.disabled = false;
              submitButton.textContent = '> ENVIAR MENSAGEM';
            }, 800);
          }

          if (data.event === 'error') {
            setSendControlsVisible(false);
            setSendStateUI('ERROR');
            setSendStats(data.success || 0, data.total || 0, data.failed || 0);
            showProgress();
            updateProgress(data.current || 0, data.total || 1, data.message || 'ERRO');
            setTimeout(() => {
              const submitButton = document.getElementById('btnSend');
              submitButton.disabled = false;
              submitButton.textContent = '> ENVIAR MENSAGEM';
            }, 800);
          }
        }
      };
    } catch (err) {
      console.error('[WS] erro ao iniciar:', err);
      setTimeout(connectWebSocket, 1500);
    }
  }

  // =========== FILES ===========
  function initDragDrop() {
    const editor = document.getElementById('messageEditor');
    const previewContainer = document.getElementById('filePreview');

    editor.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
    });

    editor.addEventListener('drop', (e) => {
      e.preventDefault();
      const files = e.dataTransfer.files;
      handleFiles(files);
    });

    function handleFiles(files) {
      for (let file of files) {
        if (attachedFiles.length >= 5) {
          showMessageModal('ERRO', 'M√ÅXIMO DE 5 ARQUIVOS POR MENSAGEM.', 'warning');
          return;
        }
        const allowedTypes = ['image/jpeg','image/png','image/gif','application/pdf','video/mp4','video/webm'];
        if (!allowedTypes.includes(file.type)) {
          showMessageModal('ERRO', 'FORMATO N√ÉO SUPORTADO. APENAS IMAGENS, PDFS E V√çDEOS.', 'danger');
          continue;
        }
        attachedFiles.push(file);
        renderPreview(file);
      }
    }

    function renderPreview(file) {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'preview-item';

      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-preview';
      removeBtn.type = 'button';
      removeBtn.textContent = '√ó';
      removeBtn.addEventListener('click', () => {
        const idx = attachedFiles.indexOf(file);
        if (idx >= 0) attachedFiles.splice(idx, 1);
        itemDiv.remove();
        updateFileInputs();
      });
      itemDiv.appendChild(removeBtn);

      if (file.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        itemDiv.appendChild(img);
      } else if (file.type === 'application/pdf') {
        const pdfIcon = document.createElement('div');
        pdfIcon.textContent = 'üìÑ';
        pdfIcon.style.fontSize = '50px';
        itemDiv.appendChild(pdfIcon);
      } else if (file.type.startsWith('video/')) {
        const video = document.createElement('video');
        video.src = URL.createObjectURL(file);
        video.style.maxWidth = '100px';
        video.style.maxHeight = '100px';
        itemDiv.appendChild(video);
      }

      const fileInfo = document.createElement('div');
      fileInfo.className = 'file-info';
      fileInfo.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
      itemDiv.appendChild(fileInfo);

      previewContainer.appendChild(itemDiv);
      updateFileInputs();
    }

    function updateFileInputs() {
      const form = document.getElementById('messageForm');
      const existingInputs = form.querySelectorAll('input[type="file"].__dynfile');
      existingInputs.forEach(input => input.remove());

      if (attachedFiles.length > 0) {
        attachedFiles.forEach((file, idx) => {
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.name = idx === 0 ? 'file' : `file${idx + 1}`;
          fileInput.className = 'd-none __dynfile';
          form.appendChild(fileInput);

          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          fileInput.files = dataTransfer.files;
        });
      }
    }
  }

  // =========== RECIPIENTS ===========
  function updateRecipientsHidden() {
    const hiddenInput = document.getElementById('recipients');
    hiddenInput.value = JSON.stringify(recipients);
  }

  function updateRecipientsList() {
    const list = document.getElementById('recipientsList');

    if (recipients.length === 0) {
      list.innerHTML = '<div class="muted" style="color:#666;">Nenhum destinat√°rio adicionado</div>';
      updateRecipientsHidden();
      refreshPreviewKpis();
      refreshSimulation();
      return;
    }

    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.flexWrap = 'wrap';
    wrapper.style.gap = '8px';

    for (let i = 0; i < recipients.length; i++) {
      const r = recipients[i];

      const tag = document.createElement('div');
      tag.className = 'recipient-tag';

      const title = document.createElement('span');
      title.textContent = r.label || r.raw;
      tag.appendChild(title);

      const hasSub = r.vars && (r.vars.nome || r.vars.email);
      if (hasSub) {
        const sub = document.createElement('span');
        sub.className = 'tag-sub';
        sub.textContent = `${r.vars.nome || ''}${r.vars.email ? ' ‚Ä¢ ' + r.vars.email : ''}`.trim();
        tag.appendChild(sub);
      }

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'remove-tag';
      btn.textContent = '√ó';
      btn.addEventListener('click', () => removeRecipient(i));
      tag.appendChild(btn);

      wrapper.appendChild(tag);
    }

    list.innerHTML = '';
    list.appendChild(wrapper);

    updateRecipientsHidden();
    refreshPreviewKpis();
    refreshSimulation();
  }

  function addRecipientFromRaw(raw, vars = {}) {
    const value = String(raw || '').trim();
    if (!value) return false;

    if (recipients.some(r => String(r.raw || '').toLowerCase() === value.toLowerCase())) return false;

    recipients.push({
      raw: value,
      label: value,
      vars: (vars && typeof vars === 'object') ? vars : {}
    });
    return true;
  }

  function addRecipient() {
    const input = document.getElementById('recipientsInput');
    const value = input.value.trim();

    if (!value) {
      showMessageModal('ERRO', 'DIGITE UM TELEFONE OU NOME DE GRUPO.', 'warning');
      return;
    }

    const ok = addRecipientFromRaw(value, {});
    if (!ok) {
      showMessageModal('AVISO', 'DESTINAT√ÅRIO J√Å ADICIONADO OU INV√ÅLIDO.', 'warning');
      return;
    }

    input.value = '';
    updateRecipientsList();
    input.focus();
  }

  function removeRecipient(index) {
    recipients.splice(index, 1);
    updateRecipientsList();
  }

  function normalizeVars(obj) {
    const out = {};
    if (!obj || typeof obj !== 'object') return out;
    for (const [k, v] of Object.entries(obj)) {
      const key = String(k || '').trim();
      if (!key) continue;
      if (key.toLowerCase() === 'telefones') continue;
      if (v === null || v === undefined) continue;
      out[key] = (typeof v === 'string') ? v : String(v);
    }
    return out;
  }

  function importContacts() {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'application/json,.json';
    fileInput.style.display = 'none';

    fileInput.addEventListener('change', () => {
      const file = fileInput.files && fileInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);

          if (!Array.isArray(parsed)) {
            showMessageModal('ERRO', 'O JSON PRECISA SER UMA LISTA (ARRAY).', 'danger');
            return;
          }

          let imported = 0;
          let skipped = 0;

          for (const contact of parsed) {
            if (!contact || typeof contact !== 'object') { skipped++; continue; }

            const vars = normalizeVars(contact);
            const name = (typeof contact.nome === 'string') ? contact.nome.trim() : '';
            const tels = Array.isArray(contact.telefones) ? contact.telefones : [];

            for (const t of tels) {
              const tel = String(t || '').trim();
              if (!tel) { skipped++; continue; }

              if (recipients.some(r => String(r.raw || '').toLowerCase() === tel.toLowerCase())) {
                skipped++;
                continue;
              }

              recipients.push({
                raw: tel,
                label: name ? `${name} - ${tel}` : tel,
                vars: { ...vars, telefone: tel }
              });
              imported++;
            }
          }

          updateRecipientsList();
          showMessageModal('SUCESSO', `IMPORTADO: ${imported} | IGNORADO: ${skipped}`, 'success');

        } catch (e) {
          console.error(e);
          showMessageModal('ERRO', 'FORMATO JSON INV√ÅLIDO. VERIFIQUE O ARQUIVO.', 'danger');
        }
      };

      reader.readAsText(file, 'utf-8');
    });

    document.body.appendChild(fileInput);
    fileInput.click();
    setTimeout(() => fileInput.remove(), 2000);
  }

  // =========== PROGRESS ===========
  function showProgress() { document.getElementById('progressContainer').style.display = 'block'; }
  function hideProgress() { document.getElementById('progressContainer').style.display = 'none'; }

  function updateProgress(current, total, text = null) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    progressText.dataset.cur = String(current);

    const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
    progressBar.style.width = percentage + '%';
    progressText.textContent = text ? text : `${current}/${total} (${percentage}%)`;

    if (current >= total) setTimeout(() => hideProgress(), 2000);
  }

  // =========== SUBMIT ===========
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const serverPlan = await tryLoadPlanBackend();
      if (serverPlan && typeof serverPlan === 'object') {
        applyPlanToInputs(serverPlan);
        savePlanLocal(serverPlan);
      } else {
        const localPlan = loadPlanLocal();
        if (localPlan) applyPlanToInputs(localPlan);
      }
    } catch {}

    recipients = [];
    updateRecipientsList();

    await loadStatus();
    connectWebSocket();

    try { initEmojiPicker(); } catch (e) { console.error('EmojiPicker init failed:', e); }
    initDragDrop();

    document.getElementById('boldBtn').addEventListener('click', (e) => { e.preventDefault(); surroundSelection('*'); });
    document.getElementById('italicBtn').addEventListener('click', (e) => { e.preventDefault(); surroundSelection('_'); });

    document.getElementById('addRecipientBtn').addEventListener('click', (e) => { e.preventDefault(); addRecipient(); });
    document.getElementById('importContactsBtn').addEventListener('click', (e) => { e.preventDefault(); importContacts(); });
    document.getElementById('toggleAdvancedBtn').addEventListener('click', (e) => { e.preventDefault(); toggleAdvanced(); });

    document.getElementById('recipientsInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); addRecipient(); }
    });

    document.getElementById('btnRefreshQR').addEventListener('click', async (e) => {
      e.preventDefault();
      await fetchAndShowQr();
    });

    document.getElementById('messageEditor').addEventListener('input', () => {
      refreshPreviewKpis();
      refreshSimulation();
    });

    bindSimulationInputs();

    document.getElementById('btnSavePlan').addEventListener('click', (e) => { e.preventDefault(); onSavePlanClick(); });
    document.getElementById('btnLoadPlan').addEventListener('click', (e) => { e.preventDefault(); onLoadPlanClick(); });
    document.getElementById('btnResetPlan').addEventListener('click', (e) => { e.preventDefault(); onResetPlanClick(); });

    document.getElementById('btnPauseSend').addEventListener('click', async (e) => { e.preventDefault(); await sendControl('pause'); });
    document.getElementById('btnResumeSend').addEventListener('click', async (e) => { e.preventDefault(); await sendControl('resume'); });
    document.getElementById('btnCancelSend').addEventListener('click', async (e) => {
      e.preventDefault();
      await sendControl('cancel');
    });

    refreshPreviewKpis();

    document.getElementById('messageForm').addEventListener('submit', async function(event) {
      event.preventDefault();

      updateHiddenTextarea();
      updateRecipientsHidden();

      const msg = document.getElementById('message').value;
      if (!msg || !msg.replace(/\s/g,'').length) {
        showMessageModal('ERRO', 'A MENSAGEM N√ÉO PODE SER VAZIA.', 'danger');
        return;
      }

      if (!recipients.length) {
        showMessageModal('ERRO', 'ADICIONE PELO MENOS 1 DESTINAT√ÅRIO.', 'danger');
        return;
      }

      const plan = buildPlanPayload();
      document.getElementById('planInput').value = JSON.stringify(plan);

      refreshSimulation();

      const formData = new FormData(this);

      const submitButton = document.getElementById('btnSend');
      submitButton.disabled = true;
      const original = submitButton.textContent;
      submitButton.textContent = 'ENVIANDO...';

      // prepara UI de progresso (vai ser atualizada pelo WS)
      setSendControlsVisible(true);
      setSendStateUI('QUEUED');
      setSendStats(0, recipients.length, 0);
      showProgress();
      updateProgress(0, recipients.length, 'ENFILEIRANDO...');

      try {
        const resp = await fetch('/api/send', { method: 'POST', body: formData });
        const data = await resp.json().catch(() => null);

        if (data && data.status === 'success') {
          currentJobId = data.jobId || null;

          showMessageModal('SUCESSO', data.message || 'ENVIO ENFILEIRADO!', 'success');

          // limpa UI do form (sem mexer no job)
          this.reset();
          document.getElementById('messageEditor').innerText = '';
          document.getElementById('filePreview').innerHTML = '';
          attachedFiles = [];
          recipients = [];
          updateRecipientsList();

          const adv = document.getElementById('advancedPanel');
          if (adv.style.display !== 'none') toggleAdvanced();
        } else {
          const emsg = (data && (data.message || data.error)) ? (data.message || data.error) : 'FALHA AO ENVIAR.';
          showMessageModal('ERRO', 'ERRO AO ENVIAR MENSAGEM: ' + emsg, 'danger');

          submitButton.disabled = false;
          submitButton.textContent = original;
          setSendControlsVisible(false);
          hideProgress();
        }
      } catch (err) {
        console.error('Erro ao enviar:', err);
        showMessageModal('ERRO', 'ERRO AO ENVIAR MENSAGEM.', 'danger');

        submitButton.disabled = false;
        submitButton.textContent = original;
        setSendControlsVisible(false);
        hideProgress();
      }
    });
  });
</script>

</body>
</html>
